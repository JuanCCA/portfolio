# 1️⃣ Etapa de build: Node con dependencias y build de Astro
FROM node:20-alpine AS builder

# Directorio de trabajo
WORKDIR /app

# Copia solo package.json y package-lock.json para cachear dependencias
COPY package*.json ./

# Instala dependencias
RUN npm install

# Copia el resto del proyecto
COPY . .

# Construye la aplicación Astro (producción)
RUN npm run build

# 2️⃣ Etapa final: servidor estático ligero con dist listo
FROM node:20-alpine AS runner

# Directorio de trabajo
WORKDIR /app

# Instala un servidor estático muy ligero (serve)
RUN npm install -g serve

# Copia la carpeta de build desde el builder
COPY --from=builder /app/dist ./dist

# Puerto que usará Dokku
ENV PORT 3000
EXPOSE 3000

# Comando de inicio para producción
CMD ["serve", "-s", "dist", "-l", "3000"]
